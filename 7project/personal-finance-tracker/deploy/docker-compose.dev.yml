# deploy/docker-compose.dev.yml
services:
  db:
    image: postgres:16                         # PostgreSQL 16 for local development
    environment:
      POSTGRES_USER: app                       # DB user
      POSTGRES_PASSWORD: app                   # DB password (dev-only)
      POSTGRES_DB: app                         # Initial database name
    volumes:
      - dbdata:/var/lib/postgresql/data        # Persist database files across restarts
    ports:
      - "5432:5432"                            # Expose Postgres to host for local tooling
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "app"] # Consider container healthy when Postgres accepts connections
      interval: 5s
      timeout: 3s
      retries: 20

  api:
    build: ../backend                          # Build backend API from local Dockerfile
    environment:
      PORT: "8080"                             # API listen port inside the container
      DB_DSN: "postgres://app:app@db:5432/app?sslmode=disable" # DSN pointing at the db service
      JWT_SECRET: "devsecret"                  # Development JWT secret (not for production use)
    depends_on:
      db:
        condition: service_healthy             # Start API only after Postgres becomes healthy
    ports:
      - "8081:8080"                            # Map host:container → access API at http://localhost:8081

  frontend:
    build: ../frontend                         # Build frontend app from local Dockerfile
    environment:
      - VITE_API_BASE=/api                     # Proxy base path used by the frontend to reach the API via nginx
    depends_on:
      - api                                    # Ensure API is available before building/serving frontend

  nginx:
    image: nginx:alpine                        # Lightweight Nginx to serve frontend and reverse-proxy API
    ports:
      - "8080:80"                              # Entry point for the dev stack → http://localhost:8080
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro # Custom Nginx vhost config
    depends_on:
      - frontend
      - api

volumes:
  dbdata:                                      # Named volume for Postgres data persistence
